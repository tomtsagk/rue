name: Create Build

on:
  push:
    branches:
      - develop
      - master
      - feature/auto-release
    tags:
      "v[0-9]+.[0-9]+.[0-9]+*"
  pull_request:
    branches:
      - develop
      - master

env:
  AVDL_PROJECT_NAME: rue
  AVDL_BUILD_URL_LINUX: https://github.com/tomtsagk/avdl/releases/download/v0.13.0/avdl_v0.13.0_linux.zip
  AVDL_BUILD_URL_WINDOWS: https://github.com/tomtsagk/avdl/releases/download/v0.13.0/avdl_v0.13.0_windows.zip

jobs:
  # Android
  android:
    if: ${{ false }}
    runs-on: ubuntu-latest
    steps:
    - name: init_project
      uses: actions/checkout@v2
    - uses: actions/setup-java@v3
      with:
        distribution: 'oracle'
        java-version: '17'
    - name: apt packages
      run: |
         sudo apt update && sudo apt install -y zipalign apksigner
    - name: get_avdl
      run: |
        wget $AVDL_BUILD_URL_LINUX -O avdl_build_linux.zip
        unzip avdl_build_linux.zip
        chmod +x avdl_build_linux/bin/avdl
    - name: generate_android_project
      run: ./avdl_build_linux/bin/avdl --android
    - name: compile
      run: |
        cd avdl_build_android
        chmod +x gradlew
        ./gradlew build
    - name: package_builds
      run: |
        mkdir "game_output"
        mkdir "game_output_debug"
        mkdir "game_output_signed"
        mv avdl_build_android/app/build/outputs/apk/release/app-universal-release-unsigned.apk "game_output/game_android.apk"
        mv avdl_build_android/app/build/outputs/apk/debug/app-universal-debug.apk "game_output_debug/game_android_debug.apk"
        cp avdl_build_android/app/build/outputs/native-debug-symbols/release/native-debug-symbols.zip "game_output_signed/native-debug-symbols.zip"
        cp avdl_build_android/app/build/outputs/mapping/release/mapping.txt "game_output_signed/mapping.txt"
        echo '${{ secrets.KEYSTORE }}' | base64 -d > keystore
        zipalign -v 4 "game_output/game_android.apk" "game_output_signed/game_android_signed.apk"
        apksigner sign --ks keystore --ks-pass 'pass:${{ secrets.KEYSTORE_PASSWORD }}' "game_output_signed/game_android_signed.apk"
        rm keystore
    - name: upload_artifact
      uses: actions/upload-artifact@v3
      with:
        name: "${{ env.AVDL_PROJECT_NAME }}_android"
        path: game_output/game_android.apk
    - name: upload_artifact_signed
      uses: actions/upload-artifact@v3
      with:
        name: "${{ env.AVDL_PROJECT_NAME }}_android_signed"
        path: game_output_signed
    - name: upload_artifact_debug
      uses: actions/upload-artifact@v3
      with:
        name: "${{ env.AVDL_PROJECT_NAME }}_android_debug"
        path: game_output_debug/game_android_debug.apk

  # Android - Admob
  android_admob:
    if: ${{ false }}
    runs-on: ubuntu-latest
    steps:
    - name: init_project
      uses: actions/checkout@v2
    - uses: actions/setup-java@v3
      with:
        distribution: 'oracle'
        java-version: '17'
    - name: apt packages
      run: |
         sudo apt update && sudo apt install -y zipalign apksigner
    - name: get_avdl
      run: |
        wget $AVDL_BUILD_URL_LINUX -O avdl_build_linux.zip
        unzip avdl_build_linux.zip
        chmod +x avdl_build_linux/bin/avdl
    - name: generate_android_project
      run: ./avdl_build_linux/bin/avdl --android --admob-ads ${{ secrets.ADMOB_PROJECT_ID }} --admob-ads-fullscreen ${{ secrets.ADMOB_INTERSTITIAL_AD_ID }}
    - name: compile
      run: |
        cd avdl_build_android
        chmod +x gradlew
        ./gradlew build
    - name: package_builds
      run: |
        mkdir "game_output"
        mkdir "game_output_debug"
        mkdir "game_output_signed"
        mv avdl_build_android/app/build/outputs/apk/release/app-universal-release-unsigned.apk "game_output/game_android.apk"
        mv avdl_build_android/app/build/outputs/apk/debug/app-universal-debug.apk "game_output_debug/game_android_debug.apk"
        cp avdl_build_android/app/build/outputs/native-debug-symbols/release/native-debug-symbols.zip "game_output_signed/native-debug-symbols.zip"
        cp avdl_build_android/app/build/outputs/mapping/release/mapping.txt "game_output_signed/mapping.txt"
        echo '${{ secrets.KEYSTORE }}' | base64 -d > keystore
        zipalign -v 4 "game_output/game_android.apk" "game_output_signed/game_android_signed.apk"
        apksigner sign --ks keystore --ks-pass 'pass:${{ secrets.KEYSTORE_PASSWORD }}' "game_output_signed/game_android_signed.apk"
        rm keystore
    - name: upload_artifact
      uses: actions/upload-artifact@v3
      with:
        name: "${{ env.AVDL_PROJECT_NAME }}_android_admob"
        path: game_output/game_android.apk
    - name: upload_artifact_signed
      uses: actions/upload-artifact@v3
      with:
        name: "${{ env.AVDL_PROJECT_NAME }}_android_admob_signed"
        path: game_output_signed
    - name: upload_artifact_debug
      uses: actions/upload-artifact@v3
      with:
        name: "${{ env.AVDL_PROJECT_NAME }}_android_admob_debug"
        path: game_output_debug/game_android_debug.apk
    - name: compile_apk
      run: |
        cd avdl_build_android
        chmod +x gradlew
        ./gradlew build
        cd ../
        mkdir game_output
        mv avdl_build_android/app/build/outputs/apk/release/app-universal-release-unsigned.apk game_output
        mkdir game_output_debug
        mv avdl_build_android/app/build/outputs/apk/debug/app-universal-debug.apk game_output_debug
    - name: upload_artifact
      uses: actions/upload-artifact@v3
      with:
        name: thekingisgone_android_admob
        path: game_output
    - name: upload_artifact_debug
      uses: actions/upload-artifact@v3
      with:
        name: thekingisgone_android_admob_debug
        path: game_output_debug

  # Android - Google Play
  android_googleplay:
    if: ${{ false }}
    runs-on: ubuntu-latest
    steps:
    - name: init_project
      uses: actions/checkout@v2
    - uses: actions/setup-java@v3
      with:
        distribution: 'oracle'
        java-version: '17'
    - name: apt packages
      run: |
         sudo apt update && sudo apt install -y zipalign apksigner
    - name: get_avdl
      run: |
        wget $AVDL_BUILD_URL_LINUX -O avdl_build_linux.zip
        unzip avdl_build_linux.zip
        chmod +x avdl_build_linux/bin/avdl
    - name: generate_android_project
      run: ./avdl_build_linux/bin/avdl --android-google-play ${{ secrets.GOOGLE_PLAY_ID }} --google-play-achievement "ACHIEVEMENT_ROSE_SELECTED" ${{ secrets.ACHIEVEMENT_ROSE_SELECTED }} --google-play-achievement "ACHIEVEMENT_EXTRA_DISCARD" ${{ secrets.ACHIEVEMENT_EXTRA_DISCARD }} --google-play-achievement "ACHIEVEMENT_I_FOUND_THE_ROSE" ${{ secrets.ACHIEVEMENT_I_FOUND_THE_ROSE }} --google-play-achievement "ACHIEVEMENT_FIRST_VICTORY" ${{ secrets.ACHIEVEMENT_FIRST_VICTORY }} --google-play-achievement "ACHIEVEMENT_GETTING_BETTER" ${{ secrets.ACHIEVEMENT_GETTING_BETTER }} --google-play-achievement "ACHIEVEMENT_MASTER_PLAYER" ${{ secrets.ACHIEVEMENT_MASTER_PLAYER }}
    - name: compile
      run: |
        cd avdl_build_android
        chmod +x gradlew
        ./gradlew build
    - name: package_builds
      run: |
        mkdir "game_output"
        mkdir "game_output_debug"
        mkdir "game_output_signed"
        mv avdl_build_android/app/build/outputs/apk/release/app-universal-release-unsigned.apk "game_output/game_android.apk"
        mv avdl_build_android/app/build/outputs/apk/debug/app-universal-debug.apk "game_output_debug/game_android_debug.apk"
        cp avdl_build_android/app/build/outputs/native-debug-symbols/release/native-debug-symbols.zip "game_output_signed/native-debug-symbols.zip"
        cp avdl_build_android/app/build/outputs/mapping/release/mapping.txt "game_output_signed/mapping.txt"
        echo '${{ secrets.KEYSTORE }}' | base64 -d > keystore
        zipalign -v 4 "game_output/game_android.apk" "game_output_signed/game_android_signed.apk"
        apksigner sign --ks keystore --ks-pass 'pass:${{ secrets.KEYSTORE_PASSWORD }}' "game_output_signed/game_android_signed.apk"
        rm keystore
    - name: upload_artifact
      uses: actions/upload-artifact@v3
      with:
        name: "${{ env.AVDL_PROJECT_NAME }}_android_googleplay"
        path: game_output/game_android.apk
    - name: upload_artifact_signed
      uses: actions/upload-artifact@v3
      with:
        name: "${{ env.AVDL_PROJECT_NAME }}_android_googleplay_signed"
        path: game_output_signed
    - name: upload_artifact_debug
      uses: actions/upload-artifact@v3
      with:
        name: "${{ env.AVDL_PROJECT_NAME }}_android_googleplay_debug"
        path: game_output_debug/game_android_debug.apk

  # Android - Google Play - Admob
  android_googleplay_admob:
    if: ${{ false }}
    runs-on: ubuntu-latest
    steps:
    - name: init_project
      uses: actions/checkout@v2
    - uses: actions/setup-java@v3
      with:
        distribution: 'oracle'
        java-version: '17'
    - name: apt packages
      run: |
         sudo apt update && sudo apt install -y zipalign apksigner
    - name: get_avdl
      run: |
        wget $AVDL_BUILD_URL_LINUX -O avdl_build_linux.zip
        unzip avdl_build_linux.zip
        chmod +x avdl_build_linux/bin/avdl
    - name: generate_android_project
      run: ./avdl_build_linux/bin/avdl --android-google-play ${{ secrets.GOOGLE_PLAY_ID }} --google-play-achievement "ACHIEVEMENT_ROSE_SELECTED" ${{ secrets.ACHIEVEMENT_ROSE_SELECTED }} --google-play-achievement "ACHIEVEMENT_EXTRA_DISCARD" ${{ secrets.ACHIEVEMENT_EXTRA_DISCARD }} --google-play-achievement "ACHIEVEMENT_I_FOUND_THE_ROSE" ${{ secrets.ACHIEVEMENT_I_FOUND_THE_ROSE }} --google-play-achievement "ACHIEVEMENT_FIRST_VICTORY" ${{ secrets.ACHIEVEMENT_FIRST_VICTORY }} --google-play-achievement "ACHIEVEMENT_GETTING_BETTER" ${{ secrets.ACHIEVEMENT_GETTING_BETTER }} --google-play-achievement "ACHIEVEMENT_MASTER_PLAYER" ${{ secrets.ACHIEVEMENT_MASTER_PLAYER }} --admob-ads ${{ secrets.ADMOB_PROJECT_ID }} --admob-ads-fullscreen ${{ secrets.ADMOB_INTERSTITIAL_AD_ID }}
    - name: compile
      run: |
        cd avdl_build_android
        chmod +x gradlew
        ./gradlew build
    - name: package_builds
      run: |
        mkdir "game_output"
        mkdir "game_output_debug"
        mkdir "game_output_signed"
        mv avdl_build_android/app/build/outputs/apk/release/app-universal-release-unsigned.apk "game_output/game_android.apk"
        mv avdl_build_android/app/build/outputs/apk/debug/app-universal-debug.apk "game_output_debug/game_android_debug.apk"
        cp avdl_build_android/app/build/outputs/native-debug-symbols/release/native-debug-symbols.zip "game_output_signed/native-debug-symbols.zip"
        cp avdl_build_android/app/build/outputs/mapping/release/mapping.txt "game_output_signed/mapping.txt"
        echo '${{ secrets.KEYSTORE }}' | base64 -d > keystore
        zipalign -v 4 "game_output/game_android.apk" "game_output_signed/game_android_signed.apk"
        apksigner sign --ks keystore --ks-pass 'pass:${{ secrets.KEYSTORE_PASSWORD }}' "game_output_signed/game_android_signed.apk"
        rm keystore
    - name: upload_artifact
      uses: actions/upload-artifact@v3
      with:
        name: "${{ env.AVDL_PROJECT_NAME }}_android_googleplay_admob"
        path: game_output/game_android.apk
    - name: upload_artifact_signed
      uses: actions/upload-artifact@v3
      with:
        name: "${{ env.AVDL_PROJECT_NAME }}_android_googleplay_admob_signed"
        path: game_output_signed
    - name: upload_artifact_debug
      uses: actions/upload-artifact@v3
      with:
        name: "${{ env.AVDL_PROJECT_NAME }}_android_googleplay_admob_debug"
        path: game_output_debug/game_android_debug.apk

  # Quest 2
  quest2:
    runs-on: ubuntu-latest
    steps:
    - name: init_project
      uses: actions/checkout@v2
    - name: apt packages
      run: |
         sudo apt update && sudo apt install -y zipalign apksigner
    - name: get_avdl
      run: |
        wget $AVDL_BUILD_URL_LINUX -O avdl_build_linux.zip
        unzip avdl_build_linux.zip
        chmod +x avdl_build_linux/bin/avdl
    - uses: actions/setup-java@v3
      with:
        distribution: 'oracle'
        java-version: '17'
    - name: generate_quest2_project
      run: ./avdl_build_linux/bin/avdl --quest2
    - name: get_oculus_sdk
      env:
        oculus_api_link: ${{ secrets.OCULUS_API_LINK }}
      run: |
        wget ${oculus_api_link} --quiet
        mkdir avdl_oculus_build
        mv oculus_mobile_sdk.zip avdl_oculus_build
        cd avdl_oculus_build
        unzip oculus_mobile_sdk.zip
        cp ../avdl_build_quest2/ -r avdl_vr_bk/AvdlProject
    - name: compile_apk
      run: |
        cd avdl_oculus_build/avdl_vr_bk/AvdlProject/Projects/Android
        chmod +x ../../../gradlew
        ../../../gradlew assembleDebug
        ../../../gradlew assembleRelease
        mv build/outputs/apk/debug/Android-debug.apk ../../../../../game_quest2_debug.apk
        mv build/outputs/apk/release/Android-release.apk ../../../../../game_quest2.apk
        echo '${{ secrets.KEYSTORE }}' | base64 -d > keystore
        zipalign -v 4 ../../../../../game_quest2.apk ../../../../../game_quest2_signed.apk
        apksigner sign --ks keystore --ks-pass 'pass:${{ secrets.KEYSTORE_PASSWORD }}' ../../../../../game_quest2_signed.apk
        rm keystore
    - name: upload_artifact_debug
      uses: actions/upload-artifact@v3
      with:
        name: ${{ env.AVDL_PROJECT_NAME }}_quest2_debug
        path: game_quest2_debug.apk
    - name: upload_artifact
      uses: actions/upload-artifact@v3
      with:
        name: ${{ env.AVDL_PROJECT_NAME }}_quest2
        path: game_quest2.apk
    - name: upload_artifact_signed
      uses: actions/upload-artifact@v3
      with:
        name: ${{ env.AVDL_PROJECT_NAME }}_quest2_signed
        path: game_quest2_signed.apk

  # Quest 2 + Oculus platform services
  quest2_oculus:
    runs-on: ubuntu-latest
    steps:
    - name: init_project
      uses: actions/checkout@v2
    - name: apt packages
      run: |
         sudo apt update && sudo apt install -y zipalign apksigner
    - name: get_avdl
      run: |
        wget $AVDL_BUILD_URL_LINUX -O avdl_build_linux.zip
        unzip avdl_build_linux.zip
        chmod +x avdl_build_linux/bin/avdl
    - uses: actions/setup-java@v3
      with:
        distribution: 'oracle'
        java-version: '17'
    - name: generate_quest2_project
      run: ./AVDL_BUILD/bin/avdl --quest2-oculus ${{ secrets.OCULUS_PROJECT_ID }}
    - name: get_oculus_sdk
      env:
        oculus_api_link: ${{ secrets.OCULUS_API_LINK }}
      run: |
        wget ${oculus_api_link} --quiet
        mkdir avdl_oculus_build
        mv oculus_mobile_sdk.zip avdl_oculus_build
        cd avdl_oculus_build
        unzip oculus_mobile_sdk.zip
        cp ../avdl_build_quest2/ -r avdl_vr_bk/AvdlProject
    - name: compile_apk
      run: |
        cd avdl_oculus_build/avdl_vr_bk/AvdlProject/Projects/Android
        chmod +x ../../../gradlew
        ../../../gradlew assembleDebug
        ../../../gradlew assembleRelease
        mv build/outputs/apk/debug/Android-debug.apk ../../../../../game_quest2_debug.apk
        mv build/outputs/apk/release/Android-release.apk ../../../../../game_quest2.apk
        echo '${{ secrets.KEYSTORE }}' | base64 -d > keystore
        zipalign -v 4 ../../../../../game_quest2.apk ../../../../../game_quest2_signed.apk
        apksigner sign --ks keystore --ks-pass 'pass:${{ secrets.KEYSTORE_PASSWORD }}' ../../../../../game_quest2_signed.apk
        rm keystore
    - name: upload_artifact_debug
      uses: actions/upload-artifact@v3
      with:
        name: ${{ env.AVDL_PROJECT_NAME }}_quest2_oculus_debug
        path: game_quest2_debug.apk
    - name: upload_artifact
      uses: actions/upload-artifact@v3
      with:
        name: ${{ env.AVDL_PROJECT_NAME }}_quest2_oculus
        path: game_quest2.apk
    - name: upload_artifact_signed
      uses: actions/upload-artifact@v3
      with:
        name: ${{ env.AVDL_PROJECT_NAME }}_quest2_oculus_signed
        path: game_quest2_signed.apk

  # Linux
  build_linux:
    if: ${{ false }}
    runs-on: ubuntu-20.04
    steps:
    - name: update packages
      run: |
         sudo apt update && sudo apt install -y gcc libgl1-mesa-dev
    - name: init_rue
      uses: actions/checkout@v1
    - name: get_avdl
      run: |
        wget $AVDL_BUILD_URL_LINUX -O avdl_build_linux.zip
        unzip avdl_build_linux.zip
        mkdir AVDL_BUILD
        mv avdl_build_linux/* AVDL_BUILD
        rmdir avdl_build_linux
    - name: compile_rue
      run: |
        chmod +x AVDL_BUILD/bin/avdl
        ./AVDL_BUILD/bin/avdl -i ./AVDL_BUILD/dependencies/linux/include -L ./AVDL_BUILD/dependencies/linux/lib --standalone
        mkdir avdl_build/dependencies
        cp ./AVDL_BUILD/dependencies/linux/lib/*.so* avdl_build/dependencies
        rm avdl_build/dependencies/*steam*
    - name: verify
      run: |
        cd avdl_build/
        chmod +x bin/rue
        LD_LIBRARY_PATH=./dependencies/ ./bin/rue --verify
        cd ../
    - name: upload_artifact
      uses: actions/upload-artifact@v3
      with:
        name: rue_build_linux
        path: avdl_build
  # Linux Steam
  build_linux_steam:
    if: ${{ false }}
    runs-on: ubuntu-20.04
    steps:
    - name: update packages
      run: |
         sudo apt update && sudo apt install -y gcc libgl1-mesa-dev
    - name: init_rue
      uses: actions/checkout@v1
    - name: get_avdl
      run: |
        wget $AVDL_BUILD_URL_LINUX -O avdl_build_linux.zip
        unzip avdl_build_linux.zip
        mkdir AVDL_BUILD
        mv avdl_build_linux/* AVDL_BUILD
        rmdir avdl_build_linux
    - name: compile_rue
      run: |
        chmod +x AVDL_BUILD/bin/avdl
        ./AVDL_BUILD/bin/avdl -i ./AVDL_BUILD/dependencies/linux/include -L ./AVDL_BUILD/dependencies/linux/lib --standalone --steam
        mkdir avdl_build/dependencies
        cp ./AVDL_BUILD/dependencies/linux/lib/*.so* avdl_build/dependencies
    - name: upload_artifact
      uses: actions/upload-artifact@v3
      with:
        name: rue_build_linux_steam
        path: avdl_build
  # Windows
  build_windows:
    if: ${{ false }}
    runs-on: windows-latest
    steps:
    - name: init_rue
      uses: actions/checkout@v1
    - name: prepare_libraries
      shell: bash
      run: |
        mkdir libraries
    - name: get_avdl
      run: |
        C:\msys64\usr\bin\wget.exe -q $Env:AVDL_BUILD_URL_WINDOWS -O avdl_build_windows.zip
    - name: unpack_avdl
      shell: bash
      run: |
        unzip avdl_build_windows.zip
        mkdir AVDL_BUILD
        mv avdl_build_windows/* AVDL_BUILD
        rmdir avdl_build_windows
        cp -r AVDL_BUILD/dependencies/windows/libpng ./libaries/
        cp -r AVDL_BUILD/dependencies/windows/zlib ./libaries/
    - name: zlib
      shell: bash
      run: |
        cp -r AVDL_BUILD/dependencies/windows/zlib "C:/Program Files (x86)/zlib"
    - name: libpng
      shell: bash
      run: |
        cp -r AVDL_BUILD/dependencies/windows/libpng "C:/Program Files (x86)/libpng"
    - name: get_libraries
      run: |
        C:\msys64\usr\bin\wget.exe -q https://github.com/nigels-com/glew/releases/download/glew-2.2.0/glew-2.2.0-win32.zip
        C:\msys64\usr\bin\wget.exe -q https://github.com/libsdl-org/SDL/releases/download/release-2.0.22/SDL2-devel-2.0.22-VC.zip
        C:\msys64\usr\bin\wget.exe -q https://github.com/libsdl-org/SDL_mixer/releases/download/release-2.6.0/SDL2_mixer-devel-2.6.0-VC.zip
    - name: glew
      shell: bash
      run: |
        mv glew-2.2.0-win32.zip libraries
        cd libraries
        unzip glew-2.2.0-win32.zip
        cd ..
    - name: sdl
      shell: bash
      run: |
        mv SDL2-devel-2.0.22-VC.zip libraries
        cd libraries
        unzip SDL2-devel-2.0.22-VC.zip
        cd ..
    - name: sdl_mixer
      shell: bash
      run: |
        mv SDL2_mixer-devel-2.6.0-VC.zip libraries
        cd libraries
        unzip SDL2_mixer-devel-2.6.0-VC.zip
        cd ..
    - name: compile_rue
      shell: bash
      run: |
        mkdir cengine
        cp -r AVDL_BUILD/share/avdl/cengine/*.c AVDL_BUILD/share/avdl/cengine/*.cpp AVDL_BUILD/include/*.h cengine
        mkdir build
        AVDL_BUILD/bin/avdl.exe -t
        AVDL_BUILD/bin/avdl.exe --cmake
        cp .avdl_cache/*.c src/
        for i in src/*.c; do mv $i ${i/.dd.c/.c}; done
        cd build
        cmake ../ . -DCMAKE_INSTALL_PREFIX="RUE_BUILD"
        cmake --build . --config Release
        cmake --install .
    - name: upload_artifact
      uses: actions/upload-artifact@v3
      with:
        name: rue_build_windows
        path: build/RUE_BUILD
    - name: upload_artifact_vs
      uses: actions/upload-artifact@v3
      with:
        name: rue_build_windows_vs
        path: build/
  # Windows Steam
  build_windows_steam:
    if: ${{ false }}
    runs-on: windows-latest
    steps:
    - name: init_rue
      uses: actions/checkout@v1
    - name: prepare_libraries
      shell: bash
      run: |
        mkdir libraries
    - name: get_avdl
      run: |
        C:\msys64\usr\bin\wget.exe -q $Env:AVDL_BUILD_URL_WINDOWS -O avdl_build_windows.zip
    - name: unpack_avdl
      shell: bash
      run: |
        unzip avdl_build_windows.zip
        mkdir AVDL_BUILD
        mv avdl_build_windows/* AVDL_BUILD
        rmdir avdl_build_windows
        cp -r AVDL_BUILD/dependencies/windows/libpng ./libaries/
        cp -r AVDL_BUILD/dependencies/windows/zlib ./libaries/
    - name: zlib
      shell: bash
      run: |
        cp -r AVDL_BUILD/dependencies/windows/zlib "C:/Program Files (x86)/zlib"
    - name: libpng
      shell: bash
      run: |
        cp -r AVDL_BUILD/dependencies/windows/libpng "C:/Program Files (x86)/libpng"
    - name: get_libraries
      run: |
        C:\msys64\usr\bin\wget.exe -q https://github.com/nigels-com/glew/releases/download/glew-2.2.0/glew-2.2.0-win32.zip
        C:\msys64\usr\bin\wget.exe -q https://github.com/libsdl-org/SDL/releases/download/release-2.0.22/SDL2-devel-2.0.22-VC.zip
        C:\msys64\usr\bin\wget.exe -q https://github.com/libsdl-org/SDL_mixer/releases/download/release-2.6.0/SDL2_mixer-devel-2.6.0-VC.zip
    - name: glew
      shell: bash
      run: |
        mv glew-2.2.0-win32.zip libraries
        cd libraries
        unzip glew-2.2.0-win32.zip
        cd ..
    - name: sdl
      shell: bash
      run: |
        mv SDL2-devel-2.0.22-VC.zip libraries
        cd libraries
        unzip SDL2-devel-2.0.22-VC.zip
        cd ..
    - name: sdl_mixer
      shell: bash
      run: |
        mv SDL2_mixer-devel-2.6.0-VC.zip libraries
        cd libraries
        unzip SDL2_mixer-devel-2.6.0-VC.zip
        cd ..
    - name: compile_rue
      shell: bash
      run: |
        mkdir cengine
        cp -r AVDL_BUILD/share/avdl/cengine/*.c AVDL_BUILD/share/avdl/cengine/*.cpp AVDL_BUILD/include/*.h cengine
        mkdir build
        ./AVDL_BUILD/bin/avdl.exe -t
        ./AVDL_BUILD/bin/avdl.exe --cmake
        cp .avdl_cache/*.c src/
        for i in src/*.c; do mv $i ${i/.dd.c/.c}; done
        cd build
        cmake ../ . -DCMAKE_INSTALL_PREFIX="RUE_BUILD" -DAVDL_STEAM=1
        cmake --build . --config Release
        cmake --install .
        cd ..
    - name: upload_artifact
      uses: actions/upload-artifact@v3
      with:
        name: rue_build_windows_steam
        path: build/RUE_BUILD
  release_itchio:
    if: ${{ false }}
    runs-on: ubuntu-20.04
    needs: [build_linux, build_windows, android, quest2]
    steps:
    - uses: actions/download-artifact@v3
      with:
        name: rue_build_linux
        path: rue_build_linux
    - uses: actions/download-artifact@v3
      with:
        name: rue_build_windows
        path: rue_build_windows
    - uses: actions/download-artifact@v3
      with:
        name: rue_android_signed
        path: rue_android_signed
    - uses: actions/download-artifact@v3
      with:
        name: rue_quest2_signed
        path: rue_quest2_signed
    - name: zip packages
      run: |
        sudo apt update && sudo apt install -y zip
        cd rue_build_linux    && zip ../rue_build_linux.zip   * -r && cd ..
        cd rue_build_windows  && zip ../rue_build_windows.zip * -r && cd ..
        cd rue_android_signed && zip ../rue_build_android.zip * -r && cd ..
        cd rue_quest2_signed  && zip ../rue_build_quest2.zip  * -r && cd ..
    - name: get butler
      run: |
        curl -L -o butler.zip https://broth.itch.ovh/butler/linux-amd64/LATEST/archive/default
        unzip butler.zip
        chmod +x butler
        ./butler -V
    - name: upload_builds
      env:
        BUTLER_API_KEY: ${{ secrets.BUTLER_API_KEY }}
      run: |
        ./butler push rue_build_linux.zip   afloofdev/test-project:linux-x86_64   --userversion 0.0.0
        ./butler push rue_build_windows.zip afloofdev/test-project:windows-x86_64 --userversion 0.0.0
        ./butler push rue_build_android.zip afloofdev/test-project:android        --userversion 0.0.0
        ./butler push rue_build_quest2.zip  afloofdev/test-project:quest2         --userversion 0.0.0
  create_release:
    if: ${{ github.ref_type == 'tag' }}
    runs-on: ubuntu-20.04
    needs: [build_linux, build_linux_steam, build_windows, build_windows_steam, android, android_googleplay, quest2, quest2_oculus]
    steps:
    - uses: actions/download-artifact@v3
      with:
        name: rue_build_linux
        path: rue_build_linux
    - uses: actions/download-artifact@v3
      with:
        name: rue_build_linux_steam
        path: rue_build_linux_steam
    - uses: actions/download-artifact@v3
      with:
        name: rue_build_windows
        path: rue_build_windows
    - uses: actions/download-artifact@v3
      with:
        name: rue_build_windows_steam
        path: rue_build_windows_steam
    - uses: actions/download-artifact@v3
      with:
        name: rue_android
        path: rue_android
    - uses: actions/download-artifact@v3
      with:
        name: rue_android_googleplay
        path: rue_android_googleplay
    - uses: actions/download-artifact@v3
      with:
        name: rue_quest2
        path: rue_quest2
    - uses: actions/download-artifact@v3
      with:
        name: rue_quest2_oculus
        path: rue_quest2_oculus
    - name: zip packages
      run: |
         sudo apt update && sudo apt install -y zip
         cd rue_build_linux         && zip ../rue_build_linux.zip              * -r && cd ..
         cd rue_build_linux_steam   && zip ../rue_build_linux_steam.zip        * -r && cd ..
         cd rue_build_windows       && zip ../rue_build_windows.zip            * -r && cd ..
         cd rue_build_windows_steam && zip ../rue_build_windows_steam.zip      * -r && cd ..
         cd rue_android             && zip ../rue_build_android.zip            * -r && cd ..
         cd rue_android_googleplay  && zip ../rue_build_android_googleplay.zip * -r && cd ..
         cd rue_quest2              && zip ../rue_build_quest2.zip             * -r && cd ..
         cd rue_quest2_oculus       && zip ../rue_build_quest2_oculus.zip      * -r && cd ..
    - name: create release
      uses: actions/create-release@v1
      id: create_release
      with:
        draft: true
        prerelease: false
        release_name: ${{ steps.version.outputs.version }}
        tag_name: ${{ github.ref }}
#        body_path: CHANGELOG.md
      env:
        GITHUB_TOKEN: ${{ github.token }}
    - name: upload linux artifact
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ github.token }}
      with:
        upload_url: ${{ steps.create_release.outputs.upload_url }}
        asset_path: rue_build_linux.zip
        asset_name: rue_${{ github.ref_name }}_linux.zip
        asset_content_type: application/gzip
    - name: upload linux steam artifact
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ github.token }}
      with:
        upload_url: ${{ steps.create_release.outputs.upload_url }}
        asset_path: rue_build_linux_steam.zip
        asset_name: rue_${{ github.ref_name }}_linux_steam.zip
        asset_content_type: application/gzip
    - name: upload windows artifact
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ github.token }}
      with:
        upload_url: ${{ steps.create_release.outputs.upload_url }}
        asset_path: rue_build_windows.zip
        asset_name: rue_${{ github.ref_name }}_windows.zip
        asset_content_type: application/gzip
    - name: upload windows steam artifact
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ github.token }}
      with:
        upload_url: ${{ steps.create_release.outputs.upload_url }}
        asset_path: rue_build_windows_steam.zip
        asset_name: rue_${{ github.ref_name }}_windows_steam.zip
        asset_content_type: application/gzip
    - name: upload android artifact
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ github.token }}
      with:
        upload_url: ${{ steps.create_release.outputs.upload_url }}
        asset_path: rue_build_android.zip
        asset_name: rue_${{ github.ref_name }}_android.zip
        asset_content_type: application/gzip
    - name: upload android_googleplay artifact
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ github.token }}
      with:
        upload_url: ${{ steps.create_release.outputs.upload_url }}
        asset_path: rue_build_android_googleplay.zip
        asset_name: rue_${{ github.ref_name }}_android_googleplay.zip
        asset_content_type: application/gzip
    - name: upload quest2 artifact
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ github.token }}
      with:
        upload_url: ${{ steps.create_release.outputs.upload_url }}
        asset_path: rue_build_quest2.zip
        asset_name: rue_${{ github.ref_name }}_quest2.zip
        asset_content_type: application/gzip
    - name: upload quest2 oculus artifact
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ github.token }}
      with:
        upload_url: ${{ steps.create_release.outputs.upload_url }}
        asset_path: rue_build_quest2_oculus.zip
        asset_name: rue_${{ github.ref_name }}_quest2_oculus.zip
        asset_content_type: application/gzip
