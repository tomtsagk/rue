# uses C behind the scenes
language: c

# only build the default `github` branch
branches:
  only:
  - master

# make builds on `bionic` and `xenial` ubuntu images
# on both `amd64` and `arm64` architectures
jobs:
  include:
    - name: Bionic Build amd64
      os: linux
      dist: bionic
      arch: amd64
#    - name: Bionic Build arm64
#      os: linux
#      dist: bionic
#      arch: arm64
#    - name: Xenial Build amd64
#      os: linux
#      dist: xenial
#      arch: amd64
#    - name: Xenial Build arm64
#      os: linux
#      dist: xenial
#      arch: arm64

# install dependencies
addons:
  apt:
    packages:
      - git
      - make

      # glew dependencies
      - build-essential
      - libxmu-dev
      - libxi-dev
      - libgl-dev

      #- libglew-dev
      #- libsdl2-dev
      #- libsdl2-mixer-dev

# compile project - add `avdl` package first
script:
  # install SDL
  - git clone https://github.com/libsdl-org/SDL SDL
  - cd SDL
  - git checkout release-2.0.20
  - mkdir build
  - cd build
  - ../configure --prefix=$HOME/AVDL_DEPENDENCIES
  - make -j6
  - sudo make -j6 install
  - cd ../..

  # install SDL_mixer
  - git clone https://github.com/libsdl-org/SDL_mixer SDL_mixer
  - cd SDL_mixer
  - git checkout release-2.0.4
  - mkdir build
  - cd build
  - ../configure --prefix=$HOME/AVDL_DEPENDENCIES
  - make -j6
  - sudo make -j6 install
  - cd ../..

  # install glew
  - git clone https://github.com/nigels-com/glew glew
  - cd glew
  - git checkout glew-2.2.0
  - cd auto
  - make
  - cd ..
  - make GLEW_DEST=$HOME/AVDL_DEPENDENCIES
  - sudo make GLEW_DEST=$HOME/AVDL_DEPENDENCIES install
  - cd ..

  # install avdl
  - git clone https://github.com/tomtsagk/avdl avdl
  - cd avdl
  - git checkout feature/automate-builds
  - make -j6
  - sudo make -j6 install
  - cd ..

  # install rue
  - make COMPILER_CUSTOM_FLAGS="-i ${HOME}/AVDL_DEPENDENCIES/include" LINKER_CUSTOM_FLAGS="-L ${HOME}/AVDL_DEPENDENCIES/lib -L ${HOME}/AVDL_DEPENDENCIES/lib64" assetdir=
  - mkdir build/native/output/dependencies
  - mkdir build/native/output/bin
  - echo "LD_LIBRARY_PATH=./dependencies/ ./bin/rue" > build/native/output/rue.sh
  - chmod +x build/native/output/rue.sh
  - mv build/native/output/rue build/native/output/bin/rue
  - cp ${HOME}/AVDL_DEPENDENCIES/lib64/libGLEW.so.2.2.0 build/native/output/dependencies/libGLEW.so.2.2
  - cp ${HOME}/AVDL_DEPENDENCIES/lib/libSDL2-2.0.so.0.18.3 build/native/output/dependencies/libSDL2-2.0.so.0
  - cp ${HOME}/AVDL_DEPENDENCIES/lib/libSDL2_mixer-2.0.so.0.2.2 build/native/output/dependencies/libSDL2_mixer-2.0.so.0
  - cd build/native/output
  - zip rue-build.zip -r *
  - cd ../../../

deploy:
  provider: releases
  api_key: "GITHUB_DEPLOY_RUE"
  file: "build/native/output/rue-build.zip"
  skip_cleanup: true
  draft: true
#  on:
#    tags: true
